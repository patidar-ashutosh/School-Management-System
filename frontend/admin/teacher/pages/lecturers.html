<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Lectures - Teacher Dashboard</title>
    <link rel="stylesheet" href="/assets/css/style.css" />
    <link rel="stylesheet" href="/assets/css/teacher.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap CSS (for alert design) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      /* Status badge styles */
      .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        text-transform: capitalize;
      }

      .status-badge.scheduled {
        background-color: #e3f2fd;
        color: #1976d2;
      }

      .status-badge.running {
        background-color: #fff3e0;
        color: #f57c00;
      }

      .status-badge.completed {
        background-color: #e8f5e8;
        color: #388e3c;
      }

      /* Tab Navigation Styles */
      .tab-navigation {
        display: flex;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 4px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .tab-button {
        flex: 1;
        padding: 12px 20px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        color: #666;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .tab-button:hover {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
      }

      .tab-button.active {
        background: #667eea;
        color: white;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body class="teacher-dashboard">
    <header class="main-header">
      <div class="header-container">
        <div class="logo">
          <i class="fas fa-school"></i>
          <span>School Management System</span>
        </div>
        <nav class="main-nav">
          <ul>
            <li>
              <a href="teacher-dashboard.html"
                ><i class="fas fa-tachometer-alt"></i> Dashboard</a
              >
            </li>
            <li>
              <a href="lecturers.html" class="active"
                ><i class="fas fa-chalkboard-teacher"></i> My Lectures</a
              >
            </li>
            <li>
              <a href="my-students.html"
                ><i class="fas fa-users"></i> My Students</a
              >
            </li>
            <li>
              <a href="attendance.html"
                ><i class="fas fa-calendar-check"></i> Attendance</a
              >
            </li>
            <li>
              <a href="assignments.html"
                ><i class="fas fa-tasks"></i> Assignments</a
              >
            </li>
            <li>
              <a href="exams.html"><i class="fas fa-file-alt"></i> Exams</a>
            </li>
          </ul>
        </nav>
        <div class="user-menu">
          <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span id="userName">Teacher</span>
          </div>
          <div class="dropdown-menu">
            <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
            <a href="#" onclick="logout()"
              ><i class="fas fa-sign-out-alt"></i> Logout</a
            >
          </div>
        </div>
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
          <i class="fas fa-bars"></i>
        </button>
      </div>
      <nav class="mobile-nav" id="mobileNav">
        <ul>
          <li>
            <a href="teacher-dashboard.html"
              ><i class="fas fa-tachometer-alt"></i> Dashboard</a
            >
          </li>
          <li>
            <a href="lecturers.html" class="active"
              ><i class="fas fa-chalkboard-teacher"></i> My Lectures</a
            >
          </li>
          <li>
            <a href="my-students.html"
              ><i class="fas fa-users"></i> My Students</a
            >
          </li>
          <li>
            <a href="attendance.html"
              ><i class="fas fa-calendar-check"></i> Attendance</a
            >
          </li>
          <li>
            <a href="assignments.html"
              ><i class="fas fa-tasks"></i> Assignments</a
            >
          </li>
          <li>
            <a href="exams.html"><i class="fas fa-file-alt"></i> Exams</a>
          </li>
        </ul>
      </nav>
    </header>
    <main class="main-content">
      <div class="page-header">
        <h1>My Lectures</h1>
        <p>Manage your scheduled lectures and view lecture details</p>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button
          class="tab-button active"
          onclick="switchTab('active')"
          id="activeTab"
        >
          <i class="fas fa-calendar-week"></i> This Week's Lectures
        </button>
        <button
          class="tab-button"
          onclick="switchTab('completed')"
          id="completedTab"
        >
          <i class="fas fa-history"></i> All Completed Lectures
        </button>
      </div>

      <!-- Active Lectures Tab Content -->
      <div id="activeTabContent" class="tab-content active">
        <div class="dashboard-cards">
          <div class="dashboard-card">
            <div class="card-header">
              <div class="card-title">Total Lectures</div>
              <div class="card-icon" style="background: #667eea">
                <i class="fas fa-chalkboard-teacher"></i>
              </div>
            </div>
            <div class="card-number" id="totalLectures">0</div>
            <div class="card-description">Scheduled lectures</div>
          </div>
          <div class="dashboard-card">
            <div class="card-header">
              <div class="card-title">Completed</div>
              <div class="card-icon" style="background: #28a745">
                <i class="fas fa-check-circle"></i>
              </div>
            </div>
            <div class="card-number" id="completedLectures">0</div>
            <div class="card-description">Completed lectures</div>
          </div>
          <div class="dashboard-card">
            <div class="card-header">
              <div class="card-title">Upcoming</div>
              <div class="card-icon" style="background: #17a2b8">
                <i class="fas fa-hourglass-start"></i>
              </div>
            </div>
            <div class="card-number" id="upcomingLectures">0</div>
            <div class="card-description">Incoming lectures</div>
          </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="search-section">
          <div class="search-box">
            <input
              type="text"
              id="searchInput"
              placeholder="Search lectures by subject or class..."
            />
            <i class="fas fa-search"></i>
          </div>
          <div class="filter-options">
            <select id="statusFilter">
              <option value="">All Status</option>
              <option value="scheduled">Scheduled</option>
              <option value="running">Running</option>
            </select>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>This Week's Lectures</h3>
            <div class="header-actions">
              <button class="btn btn-primary" onclick="openAddLectureModal()">
                <i class="fas fa-plus"></i> Add Lecture
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Subject</th>
                    <th>Class</th>
                    <th>Day</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="lecturesTableBody">
                  <!-- Dynamic rows go here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <button class="btn btn-secondary" onclick="previousPage()">
            <i class="fas fa-chevron-left"></i> Previous
          </button>
          <span id="pageInfo">Page 1 of 1</span>
          <button class="btn btn-secondary" onclick="nextPage()">
            Next <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>

      <!-- Completed Lectures Tab Content -->
      <div id="completedTabContent" class="tab-content">
        <div class="page-header">
          <h2>Completed Lecture History</h2>
          <p>View all your completed lectures</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>All Completed Lectures</h3>
            <div class="header-actions">
              <span class="completed-count"
                >Total Completed:
                <span id="totalCompletedLectures">0</span></span
              >
            </div>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Subject</th>
                    <th>Class</th>
                    <th>Day</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Completed Date</th>
                  </tr>
                </thead>
                <tbody id="completedLecturesTableBody">
                  <!-- Dynamic completed lecture rows will be rendered here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Completed Lectures Pagination -->
        <div class="pagination">
          <button class="btn btn-secondary" onclick="previousCompletedPage()">
            <i class="fas fa-chevron-left"></i> Previous
          </button>
          <span id="completedPageInfo">Page 1 of 1</span>
          <button class="btn btn-secondary" onclick="nextCompletedPage()">
            Next <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </main>
    <!-- Add/Edit Lecture Modal -->
    <div id="lectureModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Add New Lecture</h2>
          <span class="close" onclick="closeLectureModal()">&times;</span>
        </div>
        <form id="lectureForm">
          <div class="form-row">
            <div class="form-group">
              <label for="subject">Subject</label>
              <select id="subject" name="subject" required></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="class">Class</label>
              <select id="class" name="class" required></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="day">Day</label>
              <select id="day" name="day" required>
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="startTime">Start Time</label>
              <input type="time" id="startTime" name="startTime" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="endTime">End Time</label>
              <input type="time" id="endTime" name="endTime" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="status">Status</label>
              <select id="status" name="status" required>
                <option value="scheduled">Scheduled</option>
              </select>
            </div>
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeLectureModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Save Lecture</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
      <div class="modal-content delete-modal">
        <div class="modal-header">
          <h2>Confirm Delete</h2>
          <span class="close" onclick="closeDeleteModal()">&times;</span>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this lecture?</p>
          <p><strong id="deleteLectureSubject"></strong></p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeDeleteModal()">
            Cancel
          </button>
          <button class="btn btn-danger" onclick="confirmDelete()">
            Delete
          </button>
        </div>
      </div>
    </div>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/popup-alert.js"></script>
    <script>
      let lectures = [];
      let filteredLectures = [];
      let completedLectures = [];
      let filteredCompletedLectures = [];
      let currentPage = 1;
      let currentCompletedPage = 1;
      let itemsPerPage = 10;
      let editingLectureId = null;
      let deleteLectureId = null;
      let deleteLectureSubject = "";

      document.addEventListener("DOMContentLoaded", function () {
        autoUpdateLectureStatuses().then(() => {
          fetchLecturesFromDB();
        });
        loadClassesDropdown(); // Only load classes, not subjects
        setupLectureEventListeners();
      });

      async function autoUpdateLectureStatuses() {
        try {
          const response = await fetch("/backend/controllers/lecturers.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "auto_update_status" }),
          });
          const data = await response.json();
          if (data.success) {
            console.log("Lecture statuses updated automatically");
          }
        } catch (error) {
          console.error("Error updating lecture statuses:", error);
        }
      }

      function switchTab(tabName) {
        // Remove active class from all tabs and content
        document
          .querySelectorAll(".tab-button")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));

        // Add active class to selected tab and content
        if (tabName === "active") {
          document.getElementById("activeTab").classList.add("active");
          document.getElementById("activeTabContent").classList.add("active");
        } else if (tabName === "completed") {
          document.getElementById("completedTab").classList.add("active");
          document
            .getElementById("completedTabContent")
            .classList.add("active");
        }
      }

      function setupLectureEventListeners() {
        document
          .getElementById("lectureForm")
          .addEventListener("submit", handleLectureFormSubmit);
        document
          .getElementById("searchInput")
          .addEventListener("input", function () {
            filterLectures();
            filterCompletedLectures();
          });
        document
          .getElementById("statusFilter")
          .addEventListener("change", filterLectures);

        // Add real-time time validation
        document
          .getElementById("startTime")
          .addEventListener("change", validateTimeDifference);
        document
          .getElementById("endTime")
          .addEventListener("change", validateTimeDifference);
      }

      function validateTimeDifference() {
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;
        const endTimeInput = document.getElementById("endTime");

        if (startTime && endTime) {
          const start = new Date(`2000-01-01T${startTime}`);
          const end = new Date(`2000-01-01T${endTime}`);
          const diffInMinutes = (end - start) / (1000 * 60);

          if (diffInMinutes < 30) {
            endTimeInput.style.borderColor = "#dc3545";
            endTimeInput.style.backgroundColor = "#fff5f5";
            // Show small error message below the input
            let errorMsg = endTimeInput.parentNode.querySelector(".time-error");
            if (!errorMsg) {
              errorMsg = document.createElement("div");
              errorMsg.className = "time-error";
              errorMsg.style.color = "#dc3545";
              errorMsg.style.fontSize = "0.8rem";
              errorMsg.style.marginTop = "4px";
              endTimeInput.parentNode.appendChild(errorMsg);
            }
            errorMsg.textContent =
              "End time must be at least 30 minutes after start time";
          } else {
            endTimeInput.style.borderColor = "";
            endTimeInput.style.backgroundColor = "";
            const errorMsg =
              endTimeInput.parentNode.querySelector(".time-error");
            if (errorMsg) {
              errorMsg.remove();
            }
          }
        }
      }

      function fetchLecturesFromDB() {
        const user = localStorage.getItem("user");
        const teacher = user ? JSON.parse(user) : null;
        if (!teacher) return;
        fetch(`/backend/controllers/lecturers.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "get_by_teacher",
            teacher_id: teacher.id,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.data) {
              // Separate completed lectures from active lectures
              lectures = data.data.filter((lec) => lec.status !== "completed");
              completedLectures = data.data.filter(
                (lec) => lec.status === "completed"
              );

              filterLectures();
              filterCompletedLectures();
              updateLectureStats();
            } else {
              lectures = [];
              completedLectures = [];
              filterLectures();
              filterCompletedLectures();
              updateLectureStats();
            }
          })
          .catch((error) => {
            lectures = [];
            completedLectures = [];
            filterLectures();
            filterCompletedLectures();
            updateLectureStats();
          });
      }

      function filterLectures() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const statusFilter = document.getElementById("statusFilter").value;
        filteredLectures = lectures.filter((lec) => {
          const matchesSubject = (lec.subject_name || "")
            .toLowerCase()
            .includes(searchTerm);
          const matchesClass = (lec.class_name || "")
            .toLowerCase()
            .includes(searchTerm);
          const matchesSearch = matchesSubject || matchesClass;
          const matchesStatus = !statusFilter || lec.status === statusFilter;
          return matchesSearch && matchesStatus;
        });
        currentPage = 1;
        loadLectures();
      }

      function filterCompletedLectures() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        filteredCompletedLectures = completedLectures.filter((lec) => {
          const matchesSubject = (lec.subject_name || "")
            .toLowerCase()
            .includes(searchTerm);
          const matchesClass = (lec.class_name || "")
            .toLowerCase()
            .includes(searchTerm);
          const matchesSearch = matchesSubject || matchesClass;
          return matchesSearch;
        });
        currentCompletedPage = 1;
        loadCompletedLectures();
      }

      function loadLectures() {
        const tbody = document.getElementById("lecturesTableBody");
        tbody.innerHTML = "";
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageLectures = filteredLectures.slice(startIndex, endIndex);

        if (pageLectures.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center">No active lectures found.</td></tr>';
        } else {
          pageLectures.forEach((lec) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${lec.subject_name || ""}</td>
              <td>${lec.class_name || ""}</td>
              <td>${lec.day_of_week || ""}</td>
              <td>${lec.start_time || ""}</td>
              <td>${lec.end_time || ""}</td>
              <td><span class="status-badge ${lec.status}">${capitalize(
              lec.status
            )}</span></td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="editLecture('${
                  lec.id
                }')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deleteLecture('${
                  lec.id
                }', '${
              lec.subject_name
            }')"><i class="fas fa-trash"></i></button>
              </td>
            `;
            tbody.appendChild(row);
          });
        }
        updateLecturePagination();
      }

      function updateLectureStats() {
        document.getElementById("totalLectures").textContent = lectures.length;
        document.getElementById("completedLectures").textContent =
          lectures.filter((l) => l.status === "completed").length;
        document.getElementById("upcomingLectures").textContent =
          lectures.filter((l) => l.status === "scheduled").length;
        document.getElementById("totalCompletedLectures").textContent =
          completedLectures.length;
      }

      function loadCompletedLectures() {
        const tbody = document.getElementById("completedLecturesTableBody");
        tbody.innerHTML = "";
        const startIndex = (currentCompletedPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageCompletedLectures = filteredCompletedLectures.slice(
          startIndex,
          endIndex
        );

        if (pageCompletedLectures.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="text-center">No completed lectures found.</td></tr>';
        } else {
          pageCompletedLectures.forEach((lec) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${lec.subject_name || ""}</td>
              <td>${lec.class_name || ""}</td>
              <td>${lec.day_of_week || ""}</td>
              <td>${lec.start_time || ""}</td>
              <td>${lec.end_time || ""}</td>
              <td>${formatDateTime(lec.updated_at)}</td>
            `;
            tbody.appendChild(row);
          });
        }
        updateCompletedLecturePagination();
      }

      function updateLecturePagination() {
        const totalPages =
          Math.ceil(filteredLectures.length / itemsPerPage) || 1;
        document.getElementById(
          "pageInfo"
        ).textContent = `Page ${currentPage} of ${totalPages}`;
      }

      function updateCompletedLecturePagination() {
        const totalPages =
          Math.ceil(filteredCompletedLectures.length / itemsPerPage) || 1;
        document.getElementById(
          "completedPageInfo"
        ).textContent = `Page ${currentCompletedPage} of ${totalPages}`;
      }

      function previousPage() {
        if (currentPage > 1) {
          currentPage--;
          loadLectures();
        }
      }

      function nextPage() {
        const totalPages =
          Math.ceil(filteredLectures.length / itemsPerPage) || 1;
        if (currentPage < totalPages) {
          currentPage++;
          loadLectures();
        }
      }

      function previousCompletedPage() {
        if (currentCompletedPage > 1) {
          currentCompletedPage--;
          loadCompletedLectures();
        }
      }

      function nextCompletedPage() {
        const totalPages =
          Math.ceil(filteredCompletedLectures.length / itemsPerPage) || 1;
        if (currentCompletedPage < totalPages) {
          currentCompletedPage++;
          loadCompletedLectures();
        }
      }

      function loadClassesDropdown(selectedClassId = null) {
        const user = localStorage.getItem("user");
        const teacher = user ? JSON.parse(user) : null;
        const classDropdown = document.getElementById("class");
        if (!teacher || !classDropdown) return;
        fetch(`/backend/controllers/teacher_classes.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "get_classes_by_teacher",
            teacher_id: teacher.id,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            classDropdown.innerHTML = "";
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "Select class";
            classDropdown.appendChild(defaultOption);
            (data.data || []).forEach((cls) => {
              const option = document.createElement("option");
              option.value = cls.id;
              option.textContent = cls.name;
              if (selectedClassId && selectedClassId == cls.id)
                option.selected = true;
              classDropdown.appendChild(option);
            });
            classDropdown.onchange = function () {
              // loadSubjectsDropdown(); // Removed as per new logic
            };
            // resetSubjectDropdown(); // Removed as per new logic
          });
      }

      function loadSubjectDropdownForTeacher(selectedSubjectId = null) {
        const user = localStorage.getItem("user");
        const teacher = user ? JSON.parse(user) : null;
        const subjectDropdown = document.getElementById("subject");
        if (!teacher || !subjectDropdown) return;
        // Step 1: Get teacher's subject_id
        fetch(`/backend/controllers/teachers.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "get_by_id", id: teacher.id }),
        })
          .then((response) => response.json())
          .then((data) => {
            subjectDropdown.innerHTML = "";
            if (data.success && data.data && data.data.subject_id) {
              // Step 2: Get subject name from subject_id
              fetch(`/backend/controllers/subjects.php`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  action: "get_by_id",
                  id: data.data.subject_id,
                }),
              })
                .then((response) => response.json())
                .then((subjectData) => {
                  if (
                    subjectData.success &&
                    subjectData.data &&
                    subjectData.data.name
                  ) {
                    const option = document.createElement("option");
                    option.value = data.data.subject_id;
                    option.textContent = subjectData.data.name;
                    option.selected = true;
                    subjectDropdown.appendChild(option);
                    subjectDropdown.disabled = true;
                  } else {
                    const option = document.createElement("option");
                    option.value = "";
                    option.textContent = "No subject assigned";
                    subjectDropdown.appendChild(option);
                    subjectDropdown.disabled = true;
                  }
                });
            } else {
              const option = document.createElement("option");
              option.value = "";
              option.textContent = "No subject assigned";
              subjectDropdown.appendChild(option);
              subjectDropdown.disabled = true;
            }
          });
      }

      function openAddLectureModal() {
        editingLectureId = null;
        document.getElementById("modalTitle").textContent = "Add New Lecture";
        document.getElementById("lectureForm").reset();
        loadClassesDropdown();
        loadSubjectDropdownForTeacher();

        // Show status field and set it to scheduled for new lectures
        const statusField = document.querySelector(".form-group:has(#status)");
        if (statusField) {
          statusField.style.display = "block";
        }
        const statusSelect = document.getElementById("status");
        statusSelect.value = "scheduled";
        statusSelect.disabled = true;

        // Set minimum end time to 30 minutes after start time
        const startTimeInput = document.getElementById("startTime");
        const endTimeInput = document.getElementById("endTime");

        startTimeInput.addEventListener("change", function () {
          if (this.value) {
            const startTime = new Date(`2000-01-01T${this.value}`);
            const minEndTime = new Date(startTime.getTime() + 30 * 60000); // 30 minutes
            const minEndTimeStr = minEndTime.toTimeString().slice(0, 5);
            endTimeInput.min = minEndTimeStr;

            // If end time is already set and less than minimum, update it
            if (endTimeInput.value && endTimeInput.value < minEndTimeStr) {
              endTimeInput.value = minEndTimeStr;
            }
          }
        });

        document.getElementById("lectureModal").style.display = "block";
      }

      function editLecture(lectureId) {
        fetch(`/backend/controllers/lecturers.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "get", id: lectureId }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.data) {
              editingLectureId = lectureId;
              document.getElementById("modalTitle").textContent =
                "Edit Lecture";
              loadClassesDropdown(data.data.class_id);
              loadSubjectDropdownForTeacher(data.data.subject_id);
              document.getElementById("class").value = data.data.class_id;
              document.getElementById("subject").value = data.data.subject_id;
              document.getElementById("day").value = data.data.day_of_week;
              document.getElementById("startTime").value =
                data.data.start_time.slice(0, 5);
              document.getElementById("endTime").value =
                data.data.end_time.slice(0, 5);

              // Hide status field when editing since it's not changeable
              const statusField = document.querySelector(
                ".form-group:has(#status)"
              );
              if (statusField) {
                statusField.style.display = "none";
              }

              document.getElementById("lectureModal").style.display = "block";
            } else {
              showAlert(data.message || "Failed to load lecture data", "error");
            }
          })
          .catch((error) => {
            showAlert("Network error. Please try again.", "error");
          });
      }

      function closeLectureModal() {
        document.getElementById("lectureModal").style.display = "none";
        editingLectureId = null;

        // Reset and enable all form fields
        const form = document.getElementById("lectureForm");
        const subjectDropdown = document.getElementById("subject");
        const classDropdown = document.getElementById("class");
        const dayDropdown = document.getElementById("day");
        const startTimeInput = document.getElementById("startTime");
        const endTimeInput = document.getElementById("endTime");
        const statusDropdown = document.getElementById("status");

        // Enable all fields
        subjectDropdown.disabled = false;
        classDropdown.disabled = false;
        dayDropdown.disabled = false;
        startTimeInput.disabled = false;
        endTimeInput.disabled = false;
        statusDropdown.disabled = false;

        // Show status field and reset to only show scheduled option
        const statusField = document.querySelector(".form-group:has(#status)");
        if (statusField) {
          statusField.style.display = "block";
        }
        statusDropdown.innerHTML =
          '<option value="scheduled">Scheduled</option>';

        // Reset form
        form.reset();
      }

      function handleLectureFormSubmit(e) {
        e.preventDefault();

        // Validate time difference
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;

        if (startTime && endTime) {
          const start = new Date(`2000-01-01T${startTime}`);
          const end = new Date(`2000-01-01T${endTime}`);
          const diffInMinutes = (end - start) / (1000 * 60);

          if (diffInMinutes < 30) {
            showAlert(
              "End time must be at least 30 minutes after start time.",
              "error"
            );
            document.getElementById("endTime").focus();
            return;
          }
        }

        const user = localStorage.getItem("user");
        const teacher = user ? JSON.parse(user) : null;
        if (!teacher) return;
        const formData = new FormData(e.target);

        // Always use teacher's subject_id
        let subjectId = null;
        // Try to get from dropdown (if present and not empty)
        const subjectDropdown = document.getElementById("subject");
        if (subjectDropdown && subjectDropdown.value) {
          subjectId = subjectDropdown.value;
        } else if (teacher.subject_id) {
          subjectId = teacher.subject_id;
        }

        // Get status value - if field is hidden, use the current lecture's status or default to 'scheduled'
        let statusValue = formData.get("status");
        if (!statusValue) {
          if (editingLectureId) {
            // When editing, get the current lecture's status
            const currentLecture = lectures.find(
              (l) => l.id == editingLectureId
            );
            statusValue = currentLecture ? currentLecture.status : "scheduled";
          } else {
            // When adding new, default to scheduled
            statusValue = "scheduled";
          }
        }

        const lectureData = {
          subject_id: subjectId,
          class_id: formData.get("class"),
          day_of_week: formData.get("day"),
          start_time: formData.get("startTime"),
          end_time: formData.get("endTime"),
          status: statusValue,
          teacher_id: teacher.id,
        };
        fetch(`/backend/controllers/lecturers.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: editingLectureId ? "edit" : "add",
            id: editingLectureId,
            ...lectureData,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Store whether we were editing before closing modal
              const wasEditing = editingLectureId !== null;
              closeLectureModal();
              fetchLecturesFromDB();
              const message = wasEditing
                ? "Lecture updated successfully!"
                : "Lecture added successfully!";
              showAlert(message, "success");
            } else {
              showAlert(data.message || "Failed to save lecture", "error");
            }
          })
          .catch((error) => {
            showAlert("Network error. Please try again.", "error");
          });
      }

      function deleteLecture(lectureId, subjectName) {
        deleteLectureId = lectureId;
        deleteLectureSubject = subjectName;
        document.getElementById("deleteLectureSubject").textContent =
          subjectName;
        document.getElementById("deleteModal").style.display = "block";
      }

      function closeDeleteModal() {
        document.getElementById("deleteModal").style.display = "none";
        deleteLectureId = null;
        deleteLectureSubject = "";
      }

      function confirmDelete() {
        if (!deleteLectureId) return;
        fetch(`/backend/controllers/lecturers.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "delete", id: deleteLectureId }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              closeDeleteModal();
              fetchLecturesFromDB();
              showAlert("Lecture deleted successfully!", "success");
            } else {
              showAlert(data.message || "Failed to delete lecture", "error");
            }
          })
          .catch((error) => {
            showAlert("Network error. Please try again.", "error");
          });
      }

      function formatDateTime(dt) {
        if (!dt) return "";
        const d = new Date(dt);
        return d.toLocaleString();
      }

      function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("lectureModal");
        const deleteModal = document.getElementById("deleteModal");
        if (event.target === modal) {
          closeLectureModal();
        }
        if (event.target === deleteModal) {
          closeDeleteModal();
        }
      };
    </script>
  </body>
</html>
