<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assignments - Teacher Dashboard</title>
    <link rel="stylesheet" href="/assets/css/style.css" />
    <link rel="stylesheet" href="/assets/css/principal.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="teacher-dashboard">
    <header class="main-header">
      <div class="header-container">
        <div class="logo">
          <i class="fas fa-school"></i>
          <span>School Management System</span>
        </div>

        <nav class="main-nav">
          <ul>
            <li>
              <a href="teacher-dashboard.html"
                ><i class="fas fa-tachometer-alt"></i> Dashboard</a
              >
            </li>
            <li>
              <a href="lecturers.html"
                ><i class="fas fa-chalkboard-teacher"></i> My Lectures</a
              >
            </li>
            <li>
              <a href="my-students.html"
                ><i class="fas fa-users"></i> My Students</a
              >
            </li>
            <li>
              <a href="attendance.html"
                ><i class="fas fa-calendar-check"></i> Attendance</a
              >
            </li>
            <li>
              <a href="assignments.html" class="active"
                ><i class="fas fa-tasks"></i> Assignments</a
              >
            </li>
            <li>
              <a href="exams.html"><i class="fas fa-file-alt"></i> Exams</a>
            </li>
          </ul>
        </nav>

        <div class="user-menu">
          <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span id="userName">Teacher</span>
          </div>
          <div class="dropdown-menu">
            <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
            <a href="#" onclick="logout()"
              ><i class="fas fa-sign-out-alt"></i> Logout</a
            >
          </div>
        </div>

        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
          <i class="fas fa-bars"></i>
        </button>
      </div>

      <!-- Mobile Navigation -->
      <nav class="mobile-nav" id="mobileNav">
        <ul>
          <li>
            <a href="teacher-dashboard.html"
              ><i class="fas fa-tachometer-alt"></i> Dashboard</a
            >
          </li>
          <li>
            <a href="lecturers.html"
              ><i class="fas fa-chalkboard-teacher"></i> My Lectures</a
            >
          </li>
          <li>
            <a href="my-students.html"
              ><i class="fas fa-users"></i> My Students</a
            >
          </li>
          <li>
            <a href="attendance.html"
              ><i class="fas fa-calendar-check"></i> Attendance</a
            >
          </li>
          <li>
            <a href="assignments.html" class="active"
              ><i class="fas fa-tasks"></i> Assignments</a
            >
          </li>
          <li>
            <a href="exams.html"><i class="fas fa-file-alt"></i> Exams</a>
          </li>
        </ul>
      </nav>
    </header>

    <main class="main-content">
      <div class="page-header">
        <h1>Assignment Management</h1>
        <p>Create and manage assignments for your classes</p>
      </div>

      <!-- Assignment Statistics -->
      <div class="dashboard-cards">
        <div class="dashboard-card">
          <div class="card-header">
            <div class="card-title">Running Assignments</div>
            <div class="card-icon" style="background: #ffc107">
              <i class="fas fa-play-circle"></i>
            </div>
          </div>
          <div class="card-number" id="runningAssignments">-</div>
          <div class="card-description">Currently active</div>
        </div>

        <div class="dashboard-card">
          <div class="card-header">
            <div class="card-title">Coming Assignments</div>
            <div class="card-icon" style="background: #28a745">
              <i class="fas fa-calendar-plus"></i>
            </div>
          </div>
          <div class="card-number" id="comingAssignments">-</div>
          <div class="card-description">Scheduled to start</div>
        </div>

        <div class="dashboard-card">
          <div class="card-header">
            <div class="card-title">Completed Assignments</div>
            <div class="card-icon" style="background: #17a2b8">
              <i class="fas fa-check-double"></i>
            </div>
          </div>
          <div class="card-number" id="completedAssignments">-</div>
          <div class="card-description">Finished assignments</div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <div class="card-header">
          <h3>Quick Actions</h3>
        </div>
        <div class="card-body">
          <div class="quick-actions">
            <button class="btn btn-primary" onclick="createAssignment()">
              <i class="fas fa-plus"></i> Create Assignment
            </button>
            <button
              class="btn btn-info"
              onclick="window.location.href='view-submissions.html'"
            >
              <i class="fas fa-file-alt"></i> View Submissions
            </button>
          </div>
        </div>
      </div>

      <!-- Search and Filter -->
      <div class="search-section">
        <div class="search-box">
          <input
            type="text"
            id="assignmentSearch"
            placeholder="Search assignments by title..."
          />
          <i class="fas fa-search"></i>
        </div>
        <div class="filter-options">
          <select id="classFilter">
            <option value="">All Classes</option>
          </select>
          <select id="statusFilter">
            <option value="">All Status</option>
            <option value="coming">Coming</option>
            <option value="running">Running</option>
            <option value="completed">Completed</option>
          </select>
          <select id="typeFilter">
            <option value="">All Types</option>
            <option value="essays">Essays</option>
            <option value="reports">Reports</option>
            <option value="presentations">Presentations</option>
          </select>
        </div>
      </div>

      <!-- Assignments List -->
      <div class="card">
        <div class="card-header">
          <h3>My Assignments</h3>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Assignment</th>
                  <th>Class</th>
                  <th>Subject</th>
                  <th>Start Date</th>
                  <th>Type</th>
                  <th>Due Date</th>
                  <th>Total Marks</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="assignmentsTableBody">
                <!-- Dynamic assignment rows will be rendered here by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Create/Edit Assignment Modal -->
    <div id="assignmentModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="assignmentModalTitle">Create Assignment</h2>
          <span class="close" onclick="closeAssignmentModal()">&times;</span>
        </div>
        <form id="assignmentForm">
          <div class="form-row">
            <div class="form-group">
              <label for="assignmentTitle">Assignment Title *</label>
              <input type="text" id="assignmentTitle" name="title" required />
            </div>
            <div class="form-group">
              <label for="assignmentType">Type *</label>
              <select id="assignmentType" name="type" required>
                <option value="">Select type...</option>
                <option value="essays">Essays</option>
                <option value="reports">Reports</option>
                <option value="presentations">Presentations</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="assignmentClass">Class *</label>
              <select id="assignmentClass" name="class" required>
                <option value="">Select class...</option>
              </select>
            </div>
            <div class="form-group">
              <label for="assignmentSubject">Subject</label>
              <select id="assignmentSubject" name="subject" required>
                <option value="">Select subject...</option>
                <!-- Populated by JS -->
              </select>
            </div>
            <div class="form-group">
              <label for="assignmentStartDate">Start Date</label>
              <input
                type="date"
                id="assignmentStartDate"
                name="startDate"
                required
              />
            </div>
            <div class="form-group">
              <label for="assignmentDueDate">Due Date *</label>
              <input
                type="date"
                id="assignmentDueDate"
                name="dueDate"
                required
              />
            </div>
            <div class="form-group">
              <label for="assignmentTotalMarks">Total Marks *</label>
              <input
                type="number"
                id="assignmentTotalMarks"
                name="totalMarks"
                min="20"
                max="100"
                required
              />
            </div>
            <div class="form-group" id="assignmentStatusGroup">
              <label for="assignmentStatus">Status</label>
              <select id="assignmentStatus" name="status" required>
                <option value="coming">Coming</option>
                <option value="running">Running</option>
                <option value="completed">Completed</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="assignmentDescription">Description *</label>
            <textarea
              id="assignmentDescription"
              name="description"
              rows="4"
              required
            ></textarea>
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeAssignmentModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              Save Assignment
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- View Assignment Modal -->
    <div id="viewAssignmentModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Assignment Details</h2>
          <span class="close" onclick="closeViewAssignmentModal()"
            >&times;</span
          >
        </div>
        <div class="modal-body" id="viewAssignmentDetails">
          <!-- Details will be filled by JS -->
        </div>
      </div>
    </div>

    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/popup-alert.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        window.currentUser =
          window.authManager && window.authManager.getCurrentUser
            ? window.authManager.getCurrentUser()
            : JSON.parse(localStorage.getItem("user"));
        populateClassFilterDropdown();
        loadAssignmentData();
        setupSearchAndFilter();
        autoUpdateAssignmentStatuses().then(fetchAssignments);
        fetchAndUpdateHeaderName();
      });

      async function autoUpdateAssignmentStatuses() {
        try {
          await fetch("/backend/controllers/teacher_dashboard.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "auto_update_assignment_status" }),
          });
        } catch (e) {}
      }

      // Mobile menu toggle function
      function toggleMobileMenu() {
        const mobileNav = document.getElementById("mobileNav");
        const toggleBtn = document.querySelector(".mobile-menu-toggle i");

        if (mobileNav.classList.contains("active")) {
          mobileNav.classList.remove("active");
          toggleBtn.className = "fas fa-bars";
        } else {
          mobileNav.classList.add("active");
          toggleBtn.className = "fas fa-times";
        }
      }

      // Close mobile menu when clicking outside
      document.addEventListener("click", function (event) {
        const mobileNav = document.getElementById("mobileNav");
        const toggleBtn = document.querySelector(".mobile-menu-toggle");

        if (
          mobileNav.classList.contains("active") &&
          !mobileNav.contains(event.target) &&
          !toggleBtn.contains(event.target)
        ) {
          mobileNav.classList.remove("active");
          toggleBtn.querySelector("i").className = "fas fa-bars";
        }
      });

      function loadAssignmentData() {
        // Fetch real assignment statistics from database
        fetchAssignmentStatistics();
      }

      async function fetchAssignmentStatistics() {
        // Show loading state initially
        document.getElementById("runningAssignments").textContent =
          "Loading...";
        document.getElementById("comingAssignments").textContent = "Loading...";
        document.getElementById("completedAssignments").textContent =
          "Loading...";

        try {
          const response = await fetch(
            "/backend/controllers/teacher_dashboard.php",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ action: "get_assignment_statistics" }),
            }
          );

          const data = await response.json();

          if (data.success) {
            document.getElementById("runningAssignments").textContent =
              data.running_assignments || "0";
            document.getElementById("comingAssignments").textContent =
              data.coming_assignments || "0";
            document.getElementById("completedAssignments").textContent =
              data.completed_assignments || "0";
          } else {
            // Fallback to 0 if API fails
            document.getElementById("runningAssignments").textContent = "0";
            document.getElementById("comingAssignments").textContent = "0";
            document.getElementById("completedAssignments").textContent = "0";
          }
        } catch (error) {
          console.error("Error fetching assignment statistics:", error);
          // Fallback to 0 if network error
          document.getElementById("runningAssignments").textContent = "0";
          document.getElementById("comingAssignments").textContent = "0";
          document.getElementById("completedAssignments").textContent = "0";
        }
      }

      function setupSearchAndFilter() {
        document
          .getElementById("assignmentSearch")
          .addEventListener("input", filterAssignments);
        document
          .getElementById("classFilter")
          .addEventListener("change", filterAssignments);
        document
          .getElementById("statusFilter")
          .addEventListener("change", filterAssignments);
        document
          .getElementById("typeFilter")
          .addEventListener("change", filterAssignments);
      }

      let assignmentsCache = [];
      let filteredAssignments = [];
      let currentPage = 1;
      let itemsPerPage = 10;

      function filterAssignments() {
        const searchTerm = document
          .getElementById("assignmentSearch")
          .value.toLowerCase();
        const classFilter = document.getElementById("classFilter").value;
        const statusFilter = document.getElementById("statusFilter").value;
        const typeFilter = document.getElementById("typeFilter").value;

        filteredAssignments = assignmentsCache.filter((assignment) => {
          let matches = true;
          if (
            searchTerm &&
            !(
              assignment.title.toLowerCase().includes(searchTerm) ||
              (assignment.description &&
                assignment.description.toLowerCase().includes(searchTerm))
            )
          ) {
            matches = false;
          }
          if (
            classFilter &&
            String(assignment.class_id) !== String(classFilter)
          ) {
            matches = false;
          }
          if (statusFilter && assignment.status !== statusFilter) {
            matches = false;
          }
          if (typeFilter && assignment.type !== typeFilter) {
            matches = false;
          }
          return matches;
        });
        currentPage = 1;
        displayFilteredAssignments(filteredAssignments);
      }

      function displayFilteredAssignments(filteredAssignments) {
        const tbody = document.getElementById("assignmentsTableBody");
        tbody.innerHTML = "";
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageAssignments = filteredAssignments.slice(startIndex, endIndex);
        if (pageAssignments.length > 0) {
          pageAssignments.forEach((assignment) => {
            tbody.innerHTML += `
              <tr>
                <td>
                  <div class="assignment-info">
                    <strong>${assignment.title}</strong>
                    <small>${assignment.description || ""}</small>
                  </div>
                </td>
                <td>${assignment.class_name || ""}</td>
                <td>${assignment.subject_name || ""}</td>
                <td>${assignment.start_date || ""}</td>
                <td><span class="type-badge ${assignment.type}">${
              assignment.type.charAt(0).toUpperCase() + assignment.type.slice(1)
            }</span></td>
                <td>${assignment.due_date || ""}</td>
                <td>${assignment.total_marks || ""}</td>
                <td><span class="status-badge ${assignment.status}">${
              assignment.status.charAt(0).toUpperCase() +
              assignment.status.slice(1)
            }</span></td>
                <td>
                  <div class="action-buttons">
                    <button class="btn btn-sm btn-primary" onclick="viewAssignment('${
                      assignment.id
                    }')"><i class="fas fa-eye"></i></button>
                    ${
                      assignment.status !== "completed"
                        ? `<button class="btn btn-sm btn-success" onclick="editAssignment('${assignment.id}')"><i class="fas fa-edit"></i></button>`
                        : ""
                    }
                    ${
                      assignment.status !== "completed" &&
                      assignment.status !== "running"
                        ? `<button class="btn btn-sm btn-danger" onclick="deleteAssignment('${assignment.id}')"><i class="fas fa-trash"></i></button>`
                        : ""
                    }
                  </div>
                </td>
              </tr>
            `;
          });
        } else {
          tbody.innerHTML =
            '<tr><td colspan="8" style="text-align:center;">No assignments found.</td></tr>';
        }
        updatePagination(filteredAssignments.length);
      }

      function updatePagination(filteredLength) {
        const totalPages = Math.max(
          1,
          Math.ceil(
            (filteredLength !== undefined
              ? filteredLength
              : assignmentsCache.length) / itemsPerPage
          )
        );
        document.getElementById(
          "pageInfo"
        ).textContent = `Page ${currentPage} of ${totalPages}`;
      }

      function previousPage() {
        if (currentPage > 1) {
          currentPage--;
          displayFilteredAssignments(filteredAssignments);
        }
      }

      function nextPage() {
        const totalPages =
          Math.ceil(filteredAssignments.length / itemsPerPage) || 1;
        if (currentPage < totalPages) {
          currentPage++;
          displayFilteredAssignments(filteredAssignments);
        }
      }

      function populateClassFilterDropdown() {
        const user = window.currentUser;
        const classFilter = document.getElementById("classFilter");
        if (!user || !classFilter) return;
        fetch(`/backend/controllers/teacher_classes.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "get_classes_by_teacher",
            teacher_id: user.id,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            classFilter.innerHTML = "<option value=''>All Classes</option>";
            // Remove duplicate classes by id
            const uniqueClasses = {};
            (data.data || []).forEach((cls) => {
              uniqueClasses[cls.id] = cls;
            });
            // Also add the class_teacher_of class if not already present
            if (
              user.class_teacher_of &&
              !uniqueClasses[user.class_teacher_of]
            ) {
              uniqueClasses[user.class_teacher_of] = {
                id: user.class_teacher_of,
                name:
                  user.class_teacher_of_name ||
                  "Class " + user.class_teacher_of,
              };
            }
            Object.values(uniqueClasses).forEach((cls) => {
              const option = document.createElement("option");
              option.value = cls.id;
              option.textContent = cls.name;
              classFilter.appendChild(option);
            });
          });
      }

      function fetchSubjectDropdownForTeacher(selectedSubjectId = null) {
        const user = window.currentUser;
        const subjectDropdown = document.getElementById("assignmentSubject");
        if (!user || !subjectDropdown) {
          return;
        }
        fetch(`/backend/controllers/teachers.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "get_by_id", id: user.id }),
        })
          .then((response) => response.json())
          .then((data) => {
            subjectDropdown.innerHTML = "";
            if (data.success && data.data && data.data.subject_id) {
              fetch(`/backend/controllers/subjects.php`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  action: "get_by_id",
                  id: data.data.subject_id,
                }),
              })
                .then((response) => response.json())
                .then((subjectData) => {
                  if (
                    subjectData.success &&
                    subjectData.data &&
                    subjectData.data.name
                  ) {
                    const option = document.createElement("option");
                    option.value = data.data.subject_id;
                    option.textContent = subjectData.data.name;
                    option.selected = true;
                    subjectDropdown.appendChild(option);
                    subjectDropdown.disabled = true;
                  } else {
                    const option = document.createElement("option");
                    option.value = "";
                    option.textContent = "No subject assigned";
                    subjectDropdown.appendChild(option);
                    subjectDropdown.disabled = true;
                  }
                });
            } else {
              const option = document.createElement("option");
              option.value = "";
              option.textContent = "No subject assigned";
              subjectDropdown.appendChild(option);
              subjectDropdown.disabled = true;
            }
          });
      }

      function createAssignment() {
        document.getElementById("assignmentModalTitle").textContent =
          "Create Assignment";
        document.getElementById("assignmentForm").reset();
        fetchClassesDropdown();
        fetchSubjectDropdownForTeacher();
        // Set due date min to today + 5 days
        const dueDateInput = document.getElementById("assignmentDueDate");
        const minDate = new Date();
        minDate.setDate(minDate.getDate() + 5);
        dueDateInput.min = minDate.toISOString().split("T")[0];
        // Set start date min to today
        const startDateInput = document.getElementById("assignmentStartDate");
        const today = new Date();
        startDateInput.min = today.toISOString().split("T")[0];
        startDateInput.value = today.toISOString().split("T")[0];
        // Only 'coming' status, selected and disabled
        const statusSelect = document.getElementById("assignmentStatus");
        statusSelect.innerHTML =
          '<option value="coming" selected>Coming</option>';
        statusSelect.value = "coming";
        statusSelect.disabled = true;
        document.getElementById("assignmentStatusGroup").style.display =
          "block";
        document.getElementById("assignmentModal").style.display = "block";
      }

      // For assignment modal: fetch classes for the teacher
      function fetchClassesDropdown(selectedClassId = null) {
        const user = window.currentUser;
        const classDropdown = document.getElementById("assignmentClass");
        if (!user || !classDropdown) return;
        fetch(`/backend/controllers/teacher_classes.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "get_classes_by_teacher",
            teacher_id: user.id,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            classDropdown.innerHTML =
              "<option value=''>Select class...</option>";
            // Remove duplicate classes by id
            const uniqueClasses = {};
            (data.data || []).forEach((cls) => {
              uniqueClasses[cls.id] = cls;
            });
            // Also add the class_teacher_of class if not already present
            if (
              user.class_teacher_of &&
              !uniqueClasses[user.class_teacher_of]
            ) {
              uniqueClasses[user.class_teacher_of] = {
                id: user.class_teacher_of,
                name:
                  user.class_teacher_of_name ||
                  "Class " + user.class_teacher_of,
              };
            }
            Object.values(uniqueClasses).forEach((cls) => {
              const option = document.createElement("option");
              option.value = cls.id;
              option.textContent = cls.name;
              if (selectedClassId && selectedClassId == cls.id)
                option.selected = true;
              classDropdown.appendChild(option);
            });
          });
      }

      // Fetch and render assignments for the teacher
      function fetchAssignments() {
        fetch("/backend/controllers/teacher_dashboard.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "get_assignments" }),
        })
          .then((response) => response.json())
          .then((data) => {
            const tbody = document.getElementById("assignmentsTableBody");
            tbody.innerHTML = "";
            assignmentsCache = data.assignments || [];

            if (
              data.success &&
              Array.isArray(data.assignments) &&
              data.assignments.length > 0
            ) {
              data.assignments.forEach((assignment) => {
                tbody.innerHTML += `
                  <tr>
                    <td>
                      <div class="assignment-info">
                        <strong>${assignment.title}</strong>
                        <small>${assignment.description || ""}</small>
                      </div>
                    </td>
                    <td>${assignment.class_name || ""}</td>
                    <td>${assignment.subject_name || ""}</td>
                    <td>${assignment.start_date || ""}</td>
                    <td><span class="type-badge ${assignment.type}">${
                  assignment.type.charAt(0).toUpperCase() +
                  assignment.type.slice(1)
                }</span></td>
                    <td>${assignment.due_date || ""}</td>
                    <td>${assignment.total_marks || ""}</td>
                    <td><span class="status-badge ${assignment.status}">${
                  assignment.status.charAt(0).toUpperCase() +
                  assignment.status.slice(1)
                }</span></td>
                    <td>
                      <div class="action-buttons">
                        <button class="btn btn-sm btn-primary" onclick="viewAssignment('${
                          assignment.id
                        }')"><i class="fas fa-eye"></i></button>
                        ${
                          assignment.status !== "completed"
                            ? `<button class="btn btn-sm btn-success" onclick="editAssignment('${assignment.id}')"><i class="fas fa-edit"></i></button>`
                            : ""
                        }
                        ${
                          assignment.status !== "completed" &&
                          assignment.status !== "running"
                            ? `<button class="btn btn-sm btn-danger" onclick="deleteAssignment('${assignment.id}')"><i class="fas fa-trash"></i></button>`
                            : ""
                        }
                      </div>
                    </td>
                  </tr>
                `;
              });
            } else {
              tbody.innerHTML =
                '<tr><td colspan="8" style="text-align:center;">No assignments found.</td></tr>';
            }
            // Refresh statistics after loading assignments
            fetchAssignmentStatistics();
          })
          .catch((error) => {
            console.error("Error in fetchAssignments:", error);
          });
      }

      // Edit assignment: populate modal with existing data
      let editAssignmentId = null;
      function editAssignment(assignmentId) {
        document.getElementById("assignmentModalTitle").textContent =
          "Edit Assignment";
        const assignment = assignmentsCache.find(
          (a) => String(a.id) === String(assignmentId)
        );
        if (!assignment) return;
        editAssignmentId = assignmentId;
        fetchClassesDropdown(assignment.class_id);
        fetchSubjectDropdownForTeacher(assignment.subject_id);
        const form = document.getElementById("assignmentForm");
        form.title.value = assignment.title || "";
        form.description.value = assignment.description || "";
        form.class.value = assignment.class_id || "";
        form.subject.value = assignment.subject_id || "";
        // Set start date min to today and default to today if in range
        const startDateInput = document.getElementById("assignmentStartDate");
        const today = new Date();
        startDateInput.min = today.toISOString().split("T")[0];
        if (
          assignment.start_date &&
          assignment.start_date >= startDateInput.min
        ) {
          startDateInput.value = assignment.start_date;
        } else {
          startDateInput.value = startDateInput.min;
        }
        form.dueDate.value = assignment.due_date || "";
        form.totalMarks.value = assignment.total_marks || "";
        form.type.value = assignment.type || "";
        form.status.value = assignment.status || "";
        // Set due date min to today + 5 days
        const dueDateInput = document.getElementById("assignmentDueDate");
        const minDate = new Date();
        minDate.setDate(minDate.getDate() + 5);
        dueDateInput.min = minDate.toISOString().split("T")[0];
        // Enable status select for editing (will be disabled for completed/running below)
        const statusSelect = document.getElementById("assignmentStatus");
        statusSelect.innerHTML =
          '<option value="coming">Coming</option><option value="running">Running</option><option value="completed">Completed</option>';
        statusSelect.disabled = false;
        document.getElementById("assignmentStatusGroup").style.display = "none";
        document.getElementById("assignmentModal").style.display = "block";

        // Disable fields based on status
        if (assignment.status === "running") {
          // Only due date is editable
          form.title.disabled = true;
          form.description.disabled = true;
          form.class.disabled = true;
          form.subject.disabled = true;
          form.totalMarks.disabled = true;
          form.type.disabled = true;
          form.status.disabled = true;
          form.dueDate.disabled = false;
          form.startDate.disabled = true; // Disable start date if running
        } else if (assignment.status === "completed") {
          // All fields disabled
          form.title.disabled = true;
          form.description.disabled = true;
          form.class.disabled = true;
          form.subject.disabled = true;
          form.dueDate.disabled = true;
          form.totalMarks.disabled = true;
          form.type.disabled = true;
          form.status.disabled = true;
        } else {
          // All fields enabled
          form.title.disabled = false;
          form.description.disabled = false;
          form.class.disabled = false;
          form.subject.disabled = false;
          form.dueDate.disabled = false;
          form.totalMarks.disabled = false;
          form.type.disabled = false;
          form.status.disabled = false;
        }
      }

      function viewAssignment(assignmentId) {
        const assignment = assignmentsCache.find(
          (a) => String(a.id) === String(assignmentId)
        );
        if (!assignment) return;
        // Show loading
        document.getElementById("viewAssignmentDetails").innerHTML =
          "<p>Loading...</p>";
        document.getElementById("viewAssignmentModal").style.display = "block";
        // Fetch student status counts
        fetch("/backend/controllers/teacher_dashboard.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "get_assignment_student_status",
            assignment_id: assignment.id,
            class_id: assignment.class_id,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (!data.success) {
              document.getElementById(
                "viewAssignmentDetails"
              ).innerHTML = `<p>${
                data.message || "Failed to load student status."
              }</p>`;
              return;
            }
            document.getElementById("viewAssignmentDetails").innerHTML = `
              <table class="details-table">
                <tr><th>Title</th><td>${assignment.title}</td></tr>
                <tr><th>Class</th><td>${assignment.class_name || ""}</td></tr>
                <tr><th>Subject</th><td>${
                  assignment.subject_name || ""
                }</td></tr>
                <tr><th>Total Marks</th><td>${assignment.total_marks}</td></tr>
                <tr><th>Status</th><td>${
                  assignment.status.charAt(0).toUpperCase() +
                  assignment.status.slice(1)
                }</td></tr>
              </table>
              <h3>Student Status</h3>
              <table class="details-table">
                <tr><th>Pending</th><td>${data.not_submitted || 0}</td></tr>
                <tr><th>Submitted</th><td>${data.submitted || 0}</td></tr>
                <tr><th>Graded</th><td>${data.graded || 0}</td></tr>
                <tr><th>Total Students</th><td>${
                  data.total_students || 0
                }</td></tr>
              </table>
            `;
          })
          .catch(() => {
            document.getElementById("viewAssignmentDetails").innerHTML =
              "<p>Failed to load student status.</p>";
          });
      }

      function viewSubmissions(assignmentId) {
        showAlert(`Viewing submissions for assignment ${assignmentId}`, "info");
      }

      function deleteAssignment(assignmentId) {
        if (
          window.confirm("Are you sure you want to delete this assignment?")
        ) {
          fetch("/backend/controllers/teacher_dashboard.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "delete_assignment",
              id: assignmentId,
            }),
          })
            .then((response) => response.json())
            .then((res) => {
              showAlert(
                res.message || "Failed to delete assignment.",
                res.success ? "success" : "error"
              );
              if (res.success) {
                fetchAssignments(); // This will also refresh statistics
              }
            })
            .catch(() => {
              showAlert("Failed to delete assignment.", "error");
            });
        }
      }

      function exportAssignments() {
        showAlert("Exporting assignments...", "info");
      }

      // On modal close, always re-enable all fields for next use
      function closeAssignmentModal() {
        document.getElementById("assignmentModal").style.display = "none";
        const form = document.getElementById("assignmentForm");

        // Reset form
        form.reset();

        // Re-enable all fields
        [
          form.title,
          form.description,
          form.class,
          form.subject,
          form.startDate,
          form.dueDate,
          form.totalMarks,
          form.type,
          form.status,
        ].forEach((f) => {
          f.disabled = false;
        });

        // Reset edit assignment ID
        editAssignmentId = null;

        // Clear any cached form data
        form.title.value = "";
        form.description.value = "";
        form.class.value = "";
        form.subject.value = "";
        form.startDate.value = "";
        form.dueDate.value = "";
        form.totalMarks.value = "";
        form.type.value = "";
        form.status.value = "";
      }

      // Handle form submission
      document
        .getElementById("assignmentForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const user =
            window.authManager && window.authManager.getCurrentUser
              ? window.authManager.getCurrentUser()
              : JSON.parse(localStorage.getItem("user"));
          const form = e.target;
          const marks = parseInt(form.totalMarks.value, 10);
          if (isNaN(marks) || marks < 20 || marks > 100) {
            showAlert("Total marks must be between 20 and 100.", "error");
            form.totalMarks.focus();
            return;
          }
          let data = {
            title: form.title.value,
            description: form.description.value,
            class_id: form.class.value,
            subject_id: form.subject.value,
            start_date: form.startDate.value,
            due_date: form.dueDate.value,
            total_marks: form.totalMarks.value,
            type: form.type.value,
            status: form.status.value,
            teacher_id: user.id,
          };
          if (editAssignmentId) {
            data.action = "update_assignment";
            data.id = editAssignmentId;
          } else {
            data.action = "create_assignment";
          }
          fetch("/backend/controllers/teacher_dashboard.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          })
            .then((response) => response.json())
            .then((res) => {
              if (res.success) {
                const msg = editAssignmentId
                  ? "Assignment updated successfully!"
                  : "Assignment saved successfully!";

                // Close modal first
                closeAssignmentModal();

                // Reset edit assignment ID
                editAssignmentId = null;

                // Show success message
                showAlert(msg, "success");

                // Force page reload after a short delay to ensure data is refreshed
                setTimeout(() => {
                  fetchAssignments();
                  // Also refresh statistics
                  fetchAssignmentStatistics();

                  // If the data still doesn't refresh after 2 seconds, force a page reload
                  setTimeout(() => {
                    location.reload();
                  }, 2000);
                }, 500);
              } else {
                showAlert(res.message || "Failed to save assignment.", "error");
              }
            })
            .catch((error) => {
              console.error("Error saving assignment:", error);
              showAlert("Network error. Please try again.", "error");
            });
        });

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("assignmentModal");
        if (event.target === modal) {
          closeAssignmentModal();
        }
      };

      function closeViewAssignmentModal() {
        document.getElementById("viewAssignmentModal").style.display = "none";
      }

      async function fetchAndUpdateHeaderName() {
        try {
          const response = await fetch("/backend/controllers/teacher.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "get_profile" }),
          });
          const data = await response.json();
          if (data.success && data.profile) {
            // Update localStorage and header
            const auth = new Auth();
            const user = auth.getCurrentUser();
            user.first_name = data.profile.first_name;
            user.last_name = data.profile.last_name;
            localStorage.setItem("user", JSON.stringify(user));
            auth.currentUser = user;
            // Update header name
            const userNameEls = document.querySelectorAll(
              "#userName, [data-username]"
            );
            userNameEls.forEach((el) => {
              el.textContent = user.first_name + " " + user.last_name;
            });
          }
        } catch (err) {
          // ignore
        }
      }
    </script>

    <style>
      .quick-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .assignment-info {
        display: flex;
        flex-direction: column;
      }

      .assignment-info small {
        color: #666;
        font-size: 0.85rem;
      }

      .type-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .type-badge.essays {
        background: #cce5ff;
        color: #004085;
      }
      .type-badge.reports {
        background: #f8d7da;
        color: #721c24;
      }
      .type-badge.presentations {
        background: #fff3cd;
        color: #856404;
      }

      .action-buttons {
        display: flex;
        gap: 5px;
      }

      .action-buttons .btn {
        padding: 4px 8px;
        font-size: 0.8rem;
      }

      .status-badge.active {
        background: #d1ecf1;
        color: #0c5460;
      }

      .status-badge.draft {
        background: #fff3cd;
        color: #856404;
      }

      .status-badge.coming {
        background: #fff3cd;
        color: #856404;
      }

      .status-badge.running {
        background: #cce5ff;
        color: #004085;
      }

      .status-badge.completed {
        background: #d4edda;
        color: #155724;
      }

      #viewAssignmentModal.modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background: rgba(0, 0, 0, 0.4);
      }
      #viewAssignmentModal .modal-content {
        background: #fff;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        position: relative;
      }
      #viewAssignmentModal .close {
        position: absolute;
        right: 20px;
        top: 10px;
        font-size: 2rem;
        cursor: pointer;
      }
      .details-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
      }
      .details-table th,
      .details-table td {
        text-align: left;
        padding: 6px 8px;
        border-bottom: 1px solid #eee;
      }
      .details-table th {
        width: 40%;
        color: #333;
      }
    </style>
  </body>
</html>
