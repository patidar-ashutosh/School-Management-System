<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assignments - Teacher Dashboard</title>
    <link rel="stylesheet" href="/assets/css/style.css" />
    <link rel="stylesheet" href="/assets/css/principal.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="teacher-dashboard">
    <header class="main-header">
      <div class="header-container">
        <div class="logo">
          <i class="fas fa-school"></i>
          <span>School Management System</span>
        </div>

        <nav class="main-nav">
          <ul>
            <li>
              <a href="teacher-dashboard.html"
                ><i class="fas fa-tachometer-alt"></i> Dashboard</a
              >
            </li>
            <li>
              <a href="lecturers.html"
                ><i class="fas fa-chalkboard-teacher"></i> My Lectures</a
              >
            </li>
            <li>
              <a href="my-students.html"
                ><i class="fas fa-users"></i> My Students</a
              >
            </li>
            <li>
              <a href="attendance.html"
                ><i class="fas fa-calendar-check"></i> Attendance</a
              >
            </li>
            <li>
              <a href="assignments.html" class="active"
                ><i class="fas fa-tasks"></i> Assignments</a
              >
            </li>
          </ul>
        </nav>

        <div class="user-menu">
          <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span id="userName">Teacher</span>
          </div>
          <div class="dropdown-menu">
            <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
            <a href="#" onclick="logout()"
              ><i class="fas fa-sign-out-alt"></i> Logout</a
            >
          </div>
        </div>

        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
          <i class="fas fa-bars"></i>
        </button>
      </div>

      <!-- Mobile Navigation -->
      <nav class="mobile-nav" id="mobileNav">
        <ul>
          <li>
            <a href="teacher-dashboard.html"
              ><i class="fas fa-tachometer-alt"></i> Dashboard</a
            >
          </li>
          <li>
            <a href="lecturers.html"
              ><i class="fas fa-chalkboard-teacher"></i> My Lectures</a
            >
          </li>
          <li>
            <a href="my-students.html"
              ><i class="fas fa-users"></i> My Students</a
            >
          </li>
          <li>
            <a href="attendance.html"
              ><i class="fas fa-calendar-check"></i> Attendance</a
            >
          </li>
          <li>
            <a href="assignments.html" class="active"
              ><i class="fas fa-tasks"></i> Assignments</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <main class="main-content">
      <div class="page-header">
        <h1>Assignment Management</h1>
        <p>Create and manage assignments for your classes</p>
      </div>

      <!-- Assignment Statistics -->
      <div class="dashboard-cards">
        <div class="dashboard-card">
          <div class="card-header">
            <div class="card-title">Total Assignments</div>
            <div class="card-icon" style="background: #667eea">
              <i class="fas fa-tasks"></i>
            </div>
          </div>
          <div class="card-number" id="totalAssignments">15</div>
          <div class="card-description">Active assignments</div>
        </div>

        <div class="dashboard-card">
          <div class="card-header">
            <div class="card-title">Due This Week</div>
            <div class="card-icon" style="background: #ffc107">
              <i class="fas fa-clock"></i>
            </div>
          </div>
          <div class="card-number" id="dueThisWeek">3</div>
          <div class="card-description">Assignments due</div>
        </div>

        <div class="dashboard-card">
          <div class="card-header">
            <div class="card-title">Average Submission</div>
            <div class="card-icon" style="background: #28a745">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
          <div class="card-number" id="avgSubmission">85%</div>
          <div class="card-description">Submission rate</div>
        </div>

        <div class="dashboard-card">
          <div class="card-header">
            <div class="card-title">Pending Reviews</div>
            <div class="card-icon" style="background: #17a2b8">
              <i class="fas fa-eye"></i>
            </div>
          </div>
          <div class="card-number" id="pendingReviews">12</div>
          <div class="card-description">Need grading</div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <div class="card-header">
          <h3>Quick Actions</h3>
        </div>
        <div class="card-body">
          <div class="quick-actions">
            <button class="btn btn-primary" onclick="createAssignment()">
              <i class="fas fa-plus"></i> Create Assignment
            </button>
            <button
              class="btn btn-info"
              onclick="window.location.href='view-submissions.html'"
            >
              <i class="fas fa-file-alt"></i> View Submissions
            </button>
          </div>
        </div>
      </div>

      <!-- Search and Filter -->
      <div class="search-section">
        <div class="search-box">
          <input
            type="text"
            id="assignmentSearch"
            placeholder="Search assignments..."
          />
          <i class="fas fa-search"></i>
        </div>
        <div class="filter-options">
          <select id="classFilter">
            <option value="">All Classes</option>
          </select>
          <select id="statusFilter">
            <option value="">All Status</option>
            <option value="coming">Coming</option>
            <option value="running">Running</option>
            <option value="completed">Completed</option>
          </select>
          <select id="typeFilter">
            <option value="">All Types</option>
            <option value="quiz">Quiz</option>
            <option value="project">Project</option>
          </select>
        </div>
      </div>

      <!-- Assignments List -->
      <div class="card">
        <div class="card-header">
          <h3>My Assignments</h3>
          <div class="header-actions">
            <button class="btn btn-primary" onclick="exportAssignments()">
              <i class="fas fa-download"></i> Export
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Assignment</th>
                  <th>Class</th>
                  <th>Subject</th>
                  <th>Type</th>
                  <th>Due Date</th>
                  <th>Total Marks</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="assignmentsTableBody">
                <!-- Dynamic assignment rows will be rendered here by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Create/Edit Assignment Modal -->
    <div id="assignmentModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="assignmentModalTitle">Create Assignment</h2>
          <span class="close" onclick="closeAssignmentModal()">&times;</span>
        </div>
        <form id="assignmentForm">
          <div class="form-row">
            <div class="form-group">
              <label for="assignmentTitle">Assignment Title</label>
              <input type="text" id="assignmentTitle" name="title" required />
            </div>
            <div class="form-group">
              <label for="assignmentType">Type</label>
              <select id="assignmentType" name="type" required>
                <option value="">Select type...</option>
                <option value="quiz">Quiz</option>
                <option value="project">Project</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="assignmentClass">Class</label>
              <select id="assignmentClass" name="class" required>
                <option value="">Select class...</option>
              </select>
            </div>
            <div class="form-group">
              <label for="assignmentSubject">Subject</label>
              <select id="assignmentSubject" name="subject" required>
                <option value="">Select subject...</option>
                <!-- Populated by JS -->
              </select>
            </div>
            <div class="form-group">
              <label for="assignmentDueDate">Due Date</label>
              <input
                type="date"
                id="assignmentDueDate"
                name="dueDate"
                required
              />
            </div>
            <div class="form-group">
              <label for="assignmentTotalMarks">Total Marks</label>
              <input
                type="number"
                id="assignmentTotalMarks"
                name="totalMarks"
                min="1"
                max="100"
                required
              />
            </div>
            <div class="form-group">
              <label for="assignmentStatus">Status</label>
              <select id="assignmentStatus" name="status" required>
                <option value="coming">Coming</option>
                <option value="running">Running</option>
                <option value="completed">Completed</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="assignmentDescription">Description</label>
            <textarea
              id="assignmentDescription"
              name="description"
              rows="4"
              required
            ></textarea>
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeAssignmentModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              Save Assignment
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- View Assignment Modal -->
    <div id="viewAssignmentModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Assignment Details</h2>
          <span class="close" onclick="closeViewAssignmentModal()"
            >&times;</span
          >
        </div>
        <div class="modal-body" id="viewAssignmentDetails">
          <!-- Details will be filled by JS -->
        </div>
      </div>
    </div>

    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/popup-alert.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        loadAssignmentData();
        setupSearchAndFilter();
        fetchAssignments();
      });

      // Mobile menu toggle function
      function toggleMobileMenu() {
        const mobileNav = document.getElementById("mobileNav");
        const toggleBtn = document.querySelector(".mobile-menu-toggle i");

        if (mobileNav.classList.contains("active")) {
          mobileNav.classList.remove("active");
          toggleBtn.className = "fas fa-bars";
        } else {
          mobileNav.classList.add("active");
          toggleBtn.className = "fas fa-times";
        }
      }

      // Close mobile menu when clicking outside
      document.addEventListener("click", function (event) {
        const mobileNav = document.getElementById("mobileNav");
        const toggleBtn = document.querySelector(".mobile-menu-toggle");

        if (
          mobileNav.classList.contains("active") &&
          !mobileNav.contains(event.target) &&
          !toggleBtn.contains(event.target)
        ) {
          mobileNav.classList.remove("active");
          toggleBtn.querySelector("i").className = "fas fa-bars";
        }
      });

      function loadAssignmentData() {
        setTimeout(() => {
          document.getElementById("totalAssignments").textContent = "15";
          document.getElementById("dueThisWeek").textContent = "3";
          document.getElementById("avgSubmission").textContent = "85%";
          document.getElementById("pendingReviews").textContent = "12";
        }, 1000);
      }

      function setupSearchAndFilter() {
        document
          .getElementById("assignmentSearch")
          .addEventListener("input", filterAssignments);
        document
          .getElementById("classFilter")
          .addEventListener("change", filterAssignments);
        document
          .getElementById("statusFilter")
          .addEventListener("change", filterAssignments);
        document
          .getElementById("typeFilter")
          .addEventListener("change", filterAssignments);
      }

      function filterAssignments() {
        const searchTerm = document
          .getElementById("assignmentSearch")
          .value.toLowerCase();
        const classFilter = document.getElementById("classFilter").value;
        const statusFilter = document.getElementById("statusFilter").value;
        const typeFilter = document.getElementById("typeFilter").value;

        console.log("Filtering assignments:", {
          searchTerm,
          classFilter,
          statusFilter,
          typeFilter,
        });
      }

      function createAssignment() {
        document.getElementById("assignmentModalTitle").textContent =
          "Create Assignment";
        document.getElementById("assignmentForm").reset();
        fetchClasses();
        document.getElementById("assignmentModal").style.display = "block";
      }

      // Store assignments in a global variable for easy access
      let assignmentsCache = [];

      // Fetch and render assignments for the teacher
      function fetchAssignments() {
        fetch("/backend/controllers/teacher_dashboard.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "get_assignments" }),
        })
          .then((response) => response.json())
          .then((data) => {
            const tbody = document.getElementById("assignmentsTableBody");
            tbody.innerHTML = "";
            assignmentsCache = data.assignments || [];
            if (
              data.success &&
              Array.isArray(data.assignments) &&
              data.assignments.length > 0
            ) {
              data.assignments.forEach((assignment) => {
                tbody.innerHTML += `
                  <tr>
                    <td>
                      <div class="assignment-info">
                        <strong>${assignment.title}</strong>
                        <small>${assignment.description || ""}</small>
                      </div>
                    </td>
                    <td>${assignment.class_name || ""}</td>
                    <td>${assignment.subject_name || ""}</td>
                    <td><span class="type-badge ${assignment.type}">${
                  assignment.type.charAt(0).toUpperCase() +
                  assignment.type.slice(1)
                }</span></td>
                    <td>${assignment.due_date || ""}</td>
                    <td>${assignment.total_marks || ""}</td>
                    <td><span class="status-badge ${assignment.status}">${
                  assignment.status.charAt(0).toUpperCase() +
                  assignment.status.slice(1)
                }</span></td>
                    <td>
                      <div class="action-buttons">
                        <button class="btn btn-sm btn-primary" onclick="viewAssignment('${
                          assignment.id
                        }')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-success" onclick="editAssignment('${
                          assignment.id
                        }')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAssignment('${
                          assignment.id
                        }')"><i class="fas fa-trash"></i></button>
                      </div>
                    </td>
                  </tr>
                `;
              });
            } else {
              tbody.innerHTML =
                '<tr><td colspan="8" style="text-align:center;">No assignments found.</td></tr>';
            }
          });
      }

      // Edit assignment: populate modal with existing data
      let editAssignmentId = null;
      function editAssignment(assignmentId) {
        document.getElementById("assignmentModalTitle").textContent =
          "Edit Assignment";
        const assignment = assignmentsCache.find(
          (a) => String(a.id) === String(assignmentId)
        );
        if (!assignment) return;
        editAssignmentId = assignmentId;
        // Wait for both dropdowns to be loaded before setting values
        fetchClasses(function () {
          fetchSubjects(function () {
            const form = document.getElementById("assignmentForm");
            form.title.value = assignment.title || "";
            form.description.value = assignment.description || "";
            form.class.value = assignment.class_id || "";
            form.subject.value = assignment.subject_id || "";
            form.dueDate.value = assignment.due_date || "";
            form.totalMarks.value = assignment.total_marks || "";
            form.type.value = assignment.type || "";
            form.status.value = assignment.status || "";
            document.getElementById("assignmentModal").style.display = "block";
          });
        });
      }

      function viewAssignment(assignmentId) {
        const assignment = assignmentsCache.find(
          (a) => String(a.id) === String(assignmentId)
        );
        if (!assignment) return;
        // Show loading
        document.getElementById("viewAssignmentDetails").innerHTML =
          "<p>Loading...</p>";
        document.getElementById("viewAssignmentModal").style.display = "block";
        // Fetch student status counts
        fetch("/backend/controllers/teacher_dashboard.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "get_assignment_student_status",
            assignment_id: assignment.id,
            class_id: assignment.class_id,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (!data.success) {
              document.getElementById(
                "viewAssignmentDetails"
              ).innerHTML = `<p>${
                data.message || "Failed to load student status."
              }</p>`;
              return;
            }
            document.getElementById("viewAssignmentDetails").innerHTML = `
              <table class="details-table">
                <tr><th>Title</th><td>${assignment.title}</td></tr>
                <tr><th>Class</th><td>${assignment.class_name || ""}</td></tr>
                <tr><th>Subject</th><td>${
                  assignment.subject_name || ""
                }</td></tr>
                <tr><th>Total Marks</th><td>${assignment.total_marks}</td></tr>
                <tr><th>Status</th><td>${
                  assignment.status.charAt(0).toUpperCase() +
                  assignment.status.slice(1)
                }</td></tr>
              </table>
              <h3>Student Status</h3>
              <table class="details-table">
                <tr><th>Pending</th><td>${data.pending}</td></tr>
                <tr><th>Submitted</th><td>${data.submitted}</td></tr>
                <tr><th>Graded</th><td>${data.graded}</td></tr>
                <tr><th>Total Students</th><td>${data.total_students}</td></tr>
              </table>
            `;
          })
          .catch(() => {
            document.getElementById("viewAssignmentDetails").innerHTML =
              "<p>Failed to load student status.</p>";
          });
      }

      function viewSubmissions(assignmentId) {
        showAlert(`Viewing submissions for assignment ${assignmentId}`, "info");
      }

      function deleteAssignment(assignmentId) {
        if (
          window.confirm("Are you sure you want to delete this assignment?")
        ) {
          fetch("/backend/controllers/teacher_dashboard.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "delete_assignment",
              id: assignmentId,
            }),
          })
            .then((response) => response.json())
            .then((res) => {
              showAlert(
                res.message || "Failed to delete assignment.",
                res.success ? "success" : "error"
              );
              if (res.success) {
                fetchAssignments();
              }
            })
            .catch(() => {
              showAlert("Failed to delete assignment.", "error");
            });
        }
      }

      function exportAssignments() {
        showAlert("Exporting assignments...", "info");
      }

      function closeAssignmentModal() {
        document.getElementById("assignmentModal").style.display = "none";
      }

      // Handle form submission
      document
        .getElementById("assignmentForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const user =
            window.authManager && window.authManager.getCurrentUser
              ? window.authManager.getCurrentUser()
              : JSON.parse(localStorage.getItem("user"));
          const form = e.target;
          if (parseInt(form.totalMarks.value, 10) > 100) {
            showAlert("Total marks cannot be greater than 100.", "error");
            form.totalMarks.focus();
            return;
          }
          let data = {
            title: form.title.value,
            description: form.description.value,
            class_id: form.class.value,
            subject_id: form.subject.value,
            due_date: form.dueDate.value,
            total_marks: form.totalMarks.value,
            type: form.type.value,
            status: form.status.value,
            teacher_id: user.id,
          };
          if (editAssignmentId) {
            data.action = "update_assignment";
            data.id = editAssignmentId;
          } else {
            data.action = "create_assignment";
          }
          fetch("/backend/controllers/teacher_dashboard.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          })
            .then((response) => response.json())
            .then((res) => {
              console.log("Backend response:", res); // Debug backend response
              if (res.success) {
                console.log("editAssignmentId:", editAssignmentId); // Debug editAssignmentId
                const msg = editAssignmentId
                  ? "Assignment updated successfully!"
                  : "Assignment saved successfully!";
                closeAssignmentModal();
                fetchAssignments();
                showAlert(msg, "success");
                editAssignmentId = null;
              } else {
                showAlert(res.message || "Failed to save assignment.", "error");
                closeAssignmentModal();
              }
            });
        });

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("assignmentModal");
        if (event.target === modal) {
          closeAssignmentModal();
        }
      };

      // Fetch subjects from backend and populate the dropdown
      function fetchSubjects(callback) {
        fetch("/backend/controllers/subjects.php?action=get_all")
          .then((response) => response.json())
          .then((data) => {
            if (data.success && Array.isArray(data.data)) {
              const subjectSelect =
                document.getElementById("assignmentSubject");
              subjectSelect.innerHTML =
                '<option value="">Select subject...</option>';
              data.data.forEach((subject) => {
                subjectSelect.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
              });
            }
            if (callback) callback();
          });
      }
      document.addEventListener("DOMContentLoaded", function () {
        fetchSubjects();
      });

      // Fetch classes from backend and populate the dropdowns
      function fetchClasses(callback) {
        const user =
          window.authManager && window.authManager.getCurrentUser
            ? window.authManager.getCurrentUser()
            : JSON.parse(localStorage.getItem("user"));
        if (!user || !user.id) {
          if (callback) callback();
          return;
        }
        fetch("/backend/controllers/classes.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "get_by_teacher",
            teacher_id: user.id,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            const classSelect = document.getElementById("assignmentClass");
            const filterSelect = document.getElementById("classFilter");
            classSelect.innerHTML = '<option value="">Select class...</option>';
            filterSelect.innerHTML = '<option value="">All Classes</option>';
            if (data.success && Array.isArray(data.data)) {
              data.data.forEach((cls) => {
                classSelect.innerHTML += `<option value="${cls.id}">${cls.name}</option>`;
                filterSelect.innerHTML += `<option value="${cls.id}">${cls.name}</option>`;
              });
            }
            if (callback) callback();
          });
      }
      document.addEventListener("DOMContentLoaded", function () {
        fetchClasses();
      });

      function closeViewAssignmentModal() {
        document.getElementById("viewAssignmentModal").style.display = "none";
      }
    </script>

    <style>
      .quick-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .assignment-info {
        display: flex;
        flex-direction: column;
      }

      .assignment-info small {
        color: #666;
        font-size: 0.85rem;
      }

      .type-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .type-badge.homework {
        background: #d4edda;
        color: #155724;
      }

      .type-badge.quiz {
        background: #cce5ff;
        color: #004085;
      }

      .type-badge.exam {
        background: #fff3cd;
        color: #856404;
      }

      .type-badge.project {
        background: #f8d7da;
        color: #721c24;
      }

      .action-buttons {
        display: flex;
        gap: 5px;
      }

      .action-buttons .btn {
        padding: 4px 8px;
        font-size: 0.8rem;
      }

      .status-badge.active {
        background: #d1ecf1;
        color: #0c5460;
      }

      .status-badge.draft {
        background: #fff3cd;
        color: #856404;
      }

      .status-badge.coming {
        background: #fff3cd;
        color: #856404;
      }

      .status-badge.running {
        background: #cce5ff;
        color: #004085;
      }

      .status-badge.completed {
        background: #d4edda;
        color: #155724;
      }

      #viewAssignmentModal.modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background: rgba(0, 0, 0, 0.4);
      }
      #viewAssignmentModal .modal-content {
        background: #fff;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        position: relative;
      }
      #viewAssignmentModal .close {
        position: absolute;
        right: 20px;
        top: 10px;
        font-size: 2rem;
        cursor: pointer;
      }
      .details-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
      }
      .details-table th,
      .details-table td {
        text-align: left;
        padding: 6px 8px;
        border-bottom: 1px solid #eee;
      }
      .details-table th {
        width: 40%;
        color: #333;
      }
    </style>
  </body>
</html>
